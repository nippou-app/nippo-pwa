<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—¥å ±ã‚¢ãƒ—ãƒª</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#1976d2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }
    h1 { font-size: 20px; margin-bottom: 12px; }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    label {
      font-size: 14px;
      margin-top: 8px;
      display: block;
    }
    button, select, input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea { resize: vertical; }
    .value { margin-top: 6px; font-size: 14px; color: #333; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 6px;
      font-size: 14px;
      vertical-align: top;
    }
    th { background: #eee; }

    .delBtn {
      width: auto;
      padding: 6px 10px;
      font-size: 14px;
      margin-right: 6px;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã ã‘å¹…100%ã‚’å¤–ã™ */
    .checkRow {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 8px;
    }
    .checkRow input[type="checkbox"]{
      width: auto;
      transform: scale(1.2);
      margin: 0;
    }
    .checkRow span{
      font-size: 14px;
    }
  </style>
</head>

<body>
  <h1>ğŸ“˜ æ—¥å ±ã‚¢ãƒ—ãƒª</h1>

  <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
  <div class="card">
    <label>æ—¥ä»˜</label>
    <input type="date" id="date" />

    <!-- â˜…è¿½åŠ ï¼šæ—¥ã€…ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã“ãŒã€Œæ—¥ä»˜ã€ã¨ã€Œèµ°è¡Œè·é›¢ã€ã®é–“ï¼‰ -->
    <label>æ—¥ã€…ãƒã‚§ãƒƒã‚¯</label>

    <div class="checkRow">
      <input type="checkbox" id="chkCarDaily" />
      <span>ç¤¾ç”¨è»Šã®æ—¥æ¬¡ç‚¹æ¤œã‚’å®Ÿæ–½æ¸ˆ</span>
    </div>

    <div class="checkRow">
      <input type="checkbox" id="chkAlcohol" />
      <span>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½æ¸ˆ</span>
    </div>

    <label>èµ°è¡Œè·é›¢ï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰</label>

    <label>Aï¼šå‡ºå‹¤æ™‚ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆkmï¼‰</label>
    <input type="number" id="odoA" inputmode="decimal" placeholder="ä¾‹ï¼š12345">

    <label>Bï¼šé€€å‹¤æ™‚ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆkmï¼‰</label>
    <input type="number" id="odoB" inputmode="decimal" placeholder="ä¾‹ï¼š12410">

    <label>Cï¼šæœ¬æ—¥ã®èµ°è¡Œè·é›¢ï¼ˆkmï¼‰</label>
    <input type="text" id="odoC" readonly placeholder="Aã¨Bã‚’å…¥ã‚Œã‚‹ã¨è‡ªå‹•è¨ˆç®—ï¼ˆB-Aï¼‰">

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
    <select id="status">
      <option value="">æœªé¸æŠ</option>
      <option value="å‡ºå‹¤">å‡ºå‹¤</option>
      <option value="é€€å‹¤">é€€å‹¤</option>
      <option value="ç´å“">ç´å“</option>
      <option value="å¼•ãå–ã‚Š">å¼•ãå–ã‚Š</option>
      <option value="åŠ©æ‰‹">åŠ©æ‰‹</option>
      <option value="ä¼‘æ†©">ä¼‘æ†©</option>
    </select>

    <button id="startBtn" type="button">é–‹å§‹æ™‚åˆ»ã‚’å–å¾—</button>
    <div id="startTime" class="value"></div>
    <button id="startClearBtn" type="button">é–‹å§‹æ™‚åˆ»ã‚’ã‚¯ãƒªã‚¢</button>

    <button id="endBtn" type="button">çµ‚äº†æ™‚åˆ»ã‚’å–å¾—</button>
    <div id="endTime" class="value"></div>
    <button id="endClearBtn" type="button">çµ‚äº†æ™‚åˆ»ã‚’ã‚¯ãƒªã‚¢</button>

    <button id="locBtn" type="button">ç¾åœ¨åœ°ã‚’å–å¾—</button>
    <div id="location" class="value"></div>

    <label>ãƒ¡ãƒ¢</label>
    <textarea id="memo" rows="2"></textarea>

    <button id="addBtn" type="button">ç™»éŒ²</button>

    <button id="exportCsvBtn" type="button">ã“ã®æ—¥ã®CSVã‚’å‡ºåŠ›</button>
    <button id="exportJsonBtn" type="button">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’JSONã§å‡ºåŠ›ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</button>

    <hr style="margin:12px 0; border:none; border-top:1px solid #ddd;">

    <label>JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</label>
    <input type="file" id="importJsonFile" accept="application/json,.json">
    <button id="importJsonBtn" type="button">JSONã‚’èª­ã¿è¾¼ã‚“ã§å¾©å…ƒï¼ˆä¸Šæ›¸ãï¼‰</button>
  </div>

  <!-- ä¸€è¦§ -->
  <div class="card">
    <h2>ä»Šæ—¥ã®è¨˜éŒ²</h2>
    <table>
      <thead>
        <tr>
          <th>é–‹å§‹</th>
          <th>çµ‚äº†</th>
          <th>å ´æ‰€</th>
          <th>çŠ¶æ…‹</th>
          <th>ãƒ¡ãƒ¢</th>
          <th>ç·¨é›†</th>
          <th>å‰Šé™¤</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>

  <script>
    // ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®é¸æŠè‚¢ï¼ˆç·¨é›†UIã§å…±é€šåˆ©ç”¨ï¼‰ =====
    const STATUS_OPTIONS = [
      { value: '', label: 'æœªé¸æŠ' },
      { value: 'å‡ºå‹¤', label: 'å‡ºå‹¤' },
      { value: 'é€€å‹¤', label: 'é€€å‹¤' },
      { value: 'ç´å“', label: 'ç´å“' },
      { value: 'å¼•ãå–ã‚Š', label: 'å¼•ãå–ã‚Š' },
      { value: 'åŠ©æ‰‹', label: 'åŠ©æ‰‹' },
      { value: 'ä¼‘æ†©', label: 'ä¼‘æ†©' },
    ];

    function buildStatusSelect(currentValue) {
      const sel = document.createElement('select');
      sel.innerHTML = STATUS_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
      sel.value = currentValue || '';
      return sel;
    }

    // ====== å…±é€š ======
    let editingIndex = null;

    function formatDateTime(date) {
      const pad = n => String(n).padStart(2, '0');
      return (
        date.getFullYear() + '/' +
        pad(date.getMonth() + 1) + '/' +
        pad(date.getDate()) + ' ' +
        pad(date.getHours()) + ':' +
        pad(date.getMinutes())
      );
    }

    function isValidDateTimeText(s) {
      return /^\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}$/.test(String(s || '').trim());
    }

    function clearTimes() {
      document.getElementById('startTime').textContent = '';
      document.getElementById('endTime').textContent = '';
    }

    // ===== ä¿å­˜ï¼ˆæ—¥å ±è¡Œï¼‰ =====
    const STORAGE_KEY = 'nippoRecordsV1';

    function loadAll() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      } catch {
        return {};
      }
    }
    function saveAll(all) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
    }

    function getSelectedDateKey() {
      return document.getElementById('date').value;
    }

    // ===== èµ°è¡Œè·é›¢ï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰ä¿å­˜ =====
    const ODO_KEY = 'nippoOdoV1';

    function loadOdoAll() {
      try {
        return JSON.parse(localStorage.getItem(ODO_KEY) || '{}');
      } catch {
        return {};
      }
    }
    function saveOdoAll(all) {
      localStorage.setItem(ODO_KEY, JSON.stringify(all));
    }

    function calcDistance(a, b) {
      if (a === '' || b === '') return '';
      const na = Number(a);
      const nb = Number(b);
      if (!Number.isFinite(na) || !Number.isFinite(nb)) return '';
      const d = nb - na;
      return Number.isFinite(d) ? String(d) : '';
    }

    function setOdoUI(a, b) {
      document.getElementById('odoA').value = (a ?? '');
      document.getElementById('odoB').value = (b ?? '');
      document.getElementById('odoC').value = calcDistance(a ?? '', b ?? '');
    }

    function loadOdoForDate(dateKey) {
      const all = loadOdoAll();
      const data = all[dateKey] || { a: '', b: '' };
      setOdoUI(data.a ?? '', data.b ?? '');
    }

    function saveOdoForDate(dateKey) {
      const a = document.getElementById('odoA').value.trim();
      const b = document.getElementById('odoB').value.trim();

      const all = loadOdoAll();
      all[dateKey] = { a, b };
      saveOdoAll(all);

      document.getElementById('odoC').value = calcDistance(a, b);
    }

    // ===== â˜…è¿½åŠ ï¼šæ—¥ã€…ãƒã‚§ãƒƒã‚¯ä¿å­˜ =====
    const CHECKS_KEY = 'nippoDailyChecksV1';

    function loadChecksAll() {
      try {
        return JSON.parse(localStorage.getItem(CHECKS_KEY) || '{}');
      } catch {
        return {};
      }
    }
    function saveChecksAll(all) {
      localStorage.setItem(CHECKS_KEY, JSON.stringify(all));
    }

    function setChecksUI(state) {
      document.getElementById('chkCarDaily').checked = !!state?.carDaily;
      document.getElementById('chkAlcohol').checked = !!state?.alcohol;
    }

    function loadChecksForDate(dateKey) {
      const all = loadChecksAll();
      const state = all[dateKey] || { carDaily: false, alcohol: false };
      setChecksUI(state);
    }

    function saveChecksForDate(dateKey) {
      const all = loadChecksAll();
      all[dateKey] = {
        carDaily: document.getElementById('chkCarDaily').checked,
        alcohol: document.getElementById('chkAlcohol').checked,
      };
      saveChecksAll(all);
    }

    // ===== æ—¢å­˜ãƒ‡ãƒ¼ã‚¿äº’æ›ï¼šdatetime â†’ start/end ã¸å¸å =====
    function normalizeRecord(r) {
      const start = (typeof r.start === 'string') ? r.start
                  : (typeof r.datetime === 'string') ? r.datetime
                  : '';
      const end = (typeof r.end === 'string') ? r.end : '';
      return {
        start,
        end,
        location: String(r.location ?? ''),
        status: String(r.status ?? ''),
        memo: String(r.memo ?? '')
      };
    }

    // ===== è¡¨æç”»ï¼ˆç·¨é›†å¯¾å¿œï¼‰ =====
    function renderForDate(dateKey) {
      const tbody = document.getElementById('list');
      tbody.innerHTML = '';

      const all = loadAll();
      const rowsRaw = all[dateKey] || [];
      const rows = rowsRaw.map(normalizeRecord);

      // æ­£è¦åŒ–ã—ã¦ä¿å­˜ã—ç›´ã™ï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿æ··åœ¨ã§ã‚‚å®‰å®šï¼‰
      if (rowsRaw.length > 0) {
        all[dateKey] = rows;
        saveAll(all);
      }

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');

        const tdStart = document.createElement('td');
        const tdEnd = document.createElement('td');
        const tdLoc = document.createElement('td');
        const tdStatus = document.createElement('td');
        const tdMemo = document.createElement('td');
        const tdEdit = document.createElement('td');
        const tdDel = document.createElement('td');

        const isEditing = (editingIndex === idx);

        if (isEditing) {
          const startInput = document.createElement('input');
          startInput.type = 'text';
          startInput.value = r.start;
          startInput.placeholder = 'yyyy/mm/dd hh:mmï¼ˆç©ºOKï¼‰';

          const endInput = document.createElement('input');
          endInput.type = 'text';
          endInput.value = r.end;
          endInput.placeholder = 'yyyy/mm/dd hh:mmï¼ˆç©ºOKï¼‰';

          const locInput = document.createElement('input');
          locInput.type = 'text';
          locInput.value = r.location;
          locInput.placeholder = 'ç©ºã§ã‚‚OK';

          const statusSelect = buildStatusSelect(r.status);

          const memoInput = document.createElement('textarea');
          memoInput.rows = 2;
          memoInput.value = r.memo;

          tdStart.appendChild(startInput);
          tdEnd.appendChild(endInput);
          tdLoc.appendChild(locInput);
          tdStatus.appendChild(statusSelect);
          tdMemo.appendChild(memoInput);

          const saveBtn = document.createElement('button');
          saveBtn.type = 'button';
          saveBtn.textContent = 'ä¿å­˜';
          saveBtn.className = 'delBtn';

          saveBtn.addEventListener('click', () => {
            const newStart = startInput.value.trim();
            const newEnd = endInput.value.trim();
            const newLoc = locInput.value.trim();   // ç©ºOK
            const newStatus = statusSelect.value;    // æœªé¸æŠ=ç©º
            const newMemo = memoInput.value;

            // æ™‚åˆ»ã¯ã€Œå…¥ã£ã¦ã‚‹ãªã‚‰å½¢å¼ãƒã‚§ãƒƒã‚¯ã€ã€ç©ºã¯OK
            if (newStart && !isValidDateTimeText(newStart)) {
              alert('é–‹å§‹ã®å½¢å¼ãŒé•ã†ã‚ˆã€‚ä¾‹ï¼š2025/12/30 09:05');
              return;
            }
            if (newEnd && !isValidDateTimeText(newEnd)) {
              alert('çµ‚äº†ã®å½¢å¼ãŒé•ã†ã‚ˆã€‚ä¾‹ï¼š2025/12/30 18:10');
              return;
            }

            const all2 = loadAll();
            const rows2 = (all2[dateKey] || []).map(normalizeRecord);
            if (!rows2[idx]) return;

            rows2[idx].start = newStart;
            rows2[idx].end = newEnd;
            rows2[idx].location = newLoc;    // ç©ºOK
            rows2[idx].status = newStatus;
            rows2[idx].memo = String(newMemo ?? '');

            all2[dateKey] = rows2;
            saveAll(all2);

            editingIndex = null;
            renderForDate(dateKey);
          });

          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
          cancelBtn.className = 'delBtn';
          cancelBtn.addEventListener('click', () => {
            editingIndex = null;
            renderForDate(dateKey);
          });

          tdEdit.appendChild(saveBtn);
          tdEdit.appendChild(cancelBtn);
          tdDel.textContent = '';

        } else {
          tdStart.textContent = r.start;
          tdEnd.textContent = r.end;
          tdLoc.textContent = r.location;
          tdStatus.textContent = r.status;
          tdMemo.textContent = r.memo;

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.textContent = 'ç·¨é›†';
          editBtn.className = 'delBtn';
          editBtn.addEventListener('click', () => {
            editingIndex = idx;
            renderForDate(dateKey);
          });
          tdEdit.appendChild(editBtn);

          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.textContent = 'å‰Šé™¤';
          delBtn.className = 'delBtn';
          delBtn.addEventListener('click', () => {
            const ok = confirm('ã“ã®è¡Œã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ');
            if (!ok) return;

            const all2 = loadAll();
            const rows2 = (all2[dateKey] || []).map(normalizeRecord);
            rows2.splice(idx, 1);
            all2[dateKey] = rows2;
            saveAll(all2);

            editingIndex = null;
            renderForDate(dateKey);
          });
          tdDel.appendChild(delBtn);
        }

        tr.appendChild(tdStart);
        tr.appendChild(tdEnd);
        tr.appendChild(tdLoc);
        tr.appendChild(tdStatus);
        tr.appendChild(tdMemo);
        tr.appendChild(tdEdit);
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
      });
    }

    // ===== CSV/JSON å‡ºåŠ› =====
    function escapeCsvCell(value) {
      const s = String(value ?? '');
      if (/[,"\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
      return s;
    }

    function downloadText(filename, text, mime = 'text/plain', withBom = false) {
      const bom = withBom ? '\ufeff' : '';
      const blob = new Blob([bom + text], { type: mime + ';charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    // ===== JSONå¾©å…ƒï¼ˆæ¤œè¨¼ï¼‰â€»æ—§å½¢å¼ã‚‚OK =====
    function isValidAllDataShape(all) {
      if (typeof all !== 'object' || all === null || Array.isArray(all)) return false;

      for (const [dateKey, rows] of Object.entries(all)) {
        if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return false;
        if (!Array.isArray(rows)) return false;

        for (const r of rows) {
          if (typeof r !== 'object' || r === null) return false;

          const hasNew = ('start' in r) || ('end' in r);
          const hasOld = ('datetime' in r);
          if (!hasNew && !hasOld) return false;

          if (hasOld && typeof r.datetime !== 'string') return false;
          if ('start' in r && typeof r.start !== 'string') return false;
          if ('end' in r && typeof r.end !== 'string') return false;

          if (typeof r.location !== 'string') return false;
          if (typeof r.status !== 'string') return false;
          if (typeof r.memo !== 'string') return false;
        }
      }
      return true;
    }

    // ===== èµ·å‹•æ™‚è¨­å®š =====
    const today = new Date().toISOString().slice(0, 10);
    document.getElementById('date').value = today;

    function onDateChanged() {
      const dateKey = getSelectedDateKey();
      editingIndex = null;

      renderForDate(dateKey);
      loadOdoForDate(dateKey);
      loadChecksForDate(dateKey);

      // æ—¥ä»˜åˆ‡æ›¿ã§é–‹å§‹/çµ‚äº†ã¯ã‚¯ãƒªã‚¢
      clearTimes();
    }

    document.getElementById('date').addEventListener('change', onDateChanged);

    // èµ°è¡Œè·é›¢ï¼šå…¥åŠ›ã®ãŸã³ã«ä¿å­˜ï¼†Cæ›´æ–°
    document.getElementById('odoA').addEventListener('input', () => saveOdoForDate(getSelectedDateKey()));
    document.getElementById('odoB').addEventListener('input', () => saveOdoForDate(getSelectedDateKey()));

    // â˜…æ—¥ã€…ãƒã‚§ãƒƒã‚¯ï¼šå¤‰æ›´ã®ãŸã³ã«ä¿å­˜ï¼ˆå‹æ‰‹ã«å¤–ã‚Œãªã„ï¼è‡ªå‹•å‡¦ç†ã¯ã—ãªã„ï¼‰
    document.getElementById('chkCarDaily').addEventListener('change', () => saveChecksForDate(getSelectedDateKey()));
    document.getElementById('chkAlcohol').addEventListener('change', () => saveChecksForDate(getSelectedDateKey()));

    // é–‹å§‹/çµ‚äº† æ™‚åˆ»å–å¾—
    document.getElementById('startBtn').onclick = () => {
      document.getElementById('startTime').textContent = formatDateTime(new Date());
    };
    document.getElementById('endBtn').onclick = () => {
      document.getElementById('endTime').textContent = formatDateTime(new Date());
    };

    // é–‹å§‹/çµ‚äº† ã‚¯ãƒªã‚¢
    document.getElementById('startClearBtn').onclick = () => {
      document.getElementById('startTime').textContent = '';
    };
    document.getElementById('endClearBtn').onclick = () => {
      document.getElementById('endTime').textContent = '';
    };

    // ç¾åœ¨åœ°å–å¾—ï¼ˆNominatimï¼‰
    document.getElementById('locBtn').onclick = () => {
      const locEl = document.getElementById('location');
      locEl.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­â€¦';

      if (!navigator.geolocation) {
        locEl.textContent = 'ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          locEl.textContent = `ç·¯åº¦çµŒåº¦å–å¾—OKï¼ˆ${lat.toFixed(6)}, ${lon.toFixed(6)}ï¼‰â†’ ä½æ‰€å¤‰æ›ä¸­â€¦`;

          try {
            const url =
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;

            const res = await fetch(url);
            if (!res.ok) {
              locEl.textContent = `ä½æ‰€å¤‰æ›ã«å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰`;
              return;
            }

            const data = await res.json();
            const addr = data.address || {};
            const prefecture = addr.state || '';

            const city =
              addr.city ||
              addr.municipality ||
              addr.town ||
              addr.village ||
              addr.county ||
              addr.suburb ||
              '';

            locEl.textContent =
              prefecture && city
                ? `${prefecture} ${city}`
                : 'ä½æ‰€ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼‰';

          } catch (e) {
            locEl.textContent = `ä½æ‰€å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ${e?.message || e}ï¼‰`;
          }
        },
        (err) => {
          const codeMap = {
            1: 'è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆä½ç½®æƒ…å ±ã®è¨±å¯ãŒOFFï¼‰',
            2: 'ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ï¼ˆé›»æ³¢/GPS/ç«¯æœ«è¨­å®šï¼‰',
            3: 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ',
          };
          document.getElementById('location').textContent =
            `ä½ç½®æƒ…å ±ã®å–å¾—ãŒã§ãã¾ã›ã‚“ã§ã—ãŸï¼š${codeMap[err.code] || 'ä¸æ˜'} / ${err.message}`;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    };

    // ç™»éŒ²ï¼šç”»é¢ã«å…¥ã£ã¦ã‚‹é–‹å§‹/çµ‚äº†ã‚’ä¿å­˜ï¼ˆç‰‡æ–¹ç©ºã§ã‚‚OKï¼‰
    document.getElementById('addBtn').onclick = () => {
      const dateKey = getSelectedDateKey();

      const start = document.getElementById('startTime').textContent.trim();
      const end = document.getElementById('endTime').textContent.trim();

      if (start && !isValidDateTimeText(start)) {
        alert('é–‹å§‹ã®å½¢å¼ãŒé•ã†ã‚ˆã€‚ä¾‹ï¼š2025/12/30 09:05');
        return;
      }
      if (end && !isValidDateTimeText(end)) {
        alert('çµ‚äº†ã®å½¢å¼ãŒé•ã†ã‚ˆã€‚ä¾‹ï¼š2025/12/30 18:10');
        return;
      }

      const record = {
        start,
        end,
        location: document.getElementById('location').textContent || '',
        status: document.getElementById('status').value,
        memo: document.getElementById('memo').value || ''
      };

      const all = loadAll();
      all[dateKey] = (all[dateKey] || []).map(normalizeRecord);
      all[dateKey].push(record);
      saveAll(all);

      editingIndex = null;
      renderForDate(dateKey);

      // ç™»éŒ²å¾Œã‚¯ãƒªã‚¢
      document.getElementById('memo').value = '';
      clearTimes();
    };

    // CSVï¼ˆæ—¥ã”ã¨ï¼‰ï¼šèµ°è¡Œè·é›¢ï¼†ãƒã‚§ãƒƒã‚¯ã‚’å…ˆé ­ã«å…¥ã‚Œã¦ã€æ¬¡ã«æ˜ç´°
    document.getElementById('exportCsvBtn').onclick = () => {
      const dateKey = getSelectedDateKey();

      const all = loadAll();
      const rows = (all[dateKey] || []).map(normalizeRecord);

      const odoAll = loadOdoAll();
      const odo = odoAll[dateKey] || { a: '', b: '' };
      const odoC = calcDistance(String(odo.a ?? ''), String(odo.b ?? ''));

      const checksAll = loadChecksAll();
      const checks = checksAll[dateKey] || { carDaily: false, alcohol: false };

      if (rows.length === 0 && (String(odo.a ?? '') === '' && String(odo.b ?? '') === '') && !checks.carDaily && !checks.alcohol) {
        alert('ã“ã®æ—¥ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆèµ°è¡Œè·é›¢ãƒ»ãƒã‚§ãƒƒã‚¯ã‚‚æœªå…¥åŠ›ï¼‰');
        return;
      }

      const metaLines = [
        ['æ—¥ä»˜', dateKey],
        ['èµ°è¡Œè·é›¢Aï¼ˆå‡ºå‹¤ãƒ¡ãƒ¼ã‚¿ãƒ¼kmï¼‰', odo.a ?? ''],
        ['èµ°è¡Œè·é›¢Bï¼ˆé€€å‹¤ãƒ¡ãƒ¼ã‚¿ãƒ¼kmï¼‰', odo.b ?? ''],
        ['èµ°è¡Œè·é›¢Cï¼ˆæœ¬æ—¥ã®èµ°è¡Œè·é›¢kmï¼‰', odoC],
        ['ç¤¾ç”¨è»Šã®æ—¥æ¬¡ç‚¹æ¤œã‚’å®Ÿæ–½æ¸ˆ', checks.carDaily ? '1' : '0'],
        ['ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½æ¸ˆ', checks.alcohol ? '1' : '0'],
        [], // ç©ºè¡Œ
      ].map(cols => (cols.length ? cols.map(escapeCsvCell).join(',') : ''));

      const header = ['é–‹å§‹', 'çµ‚äº†', 'å ´æ‰€', 'çŠ¶æ…‹', 'ãƒ¡ãƒ¢'];
      const lines = [header.map(escapeCsvCell).join(',')];

      for (const r of rows) {
        lines.push([r.start, r.end, r.location, r.status, r.memo].map(escapeCsvCell).join(','));
      }

      const csvText = metaLines.join('\n') + '\n' + lines.join('\n');
      downloadText(`nippo_${dateKey.replaceAll('-', '')}.csv`, csvText, 'text/csv', true);
    };

    // JSONå‡ºåŠ›ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰
    document.getElementById('exportJsonBtn').onclick = () => {
      const all = loadAll();
      if (!all || Object.keys(all).length === 0) {
        alert('ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      const stamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '');
      downloadText(`nippo_backup_${stamp}.json`, JSON.stringify(all, null, 2), 'application/json', false);
    };

    // å¾©å…ƒï¼ˆJSONä¸Šæ›¸ãï¼‰
    document.getElementById('importJsonBtn').onclick = async () => {
      const fileInput = document.getElementById('importJsonFile');
      const file = fileInput.files && fileInput.files[0];

      if (!file) {
        alert('å¾©å…ƒã™ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­');
        return;
      }

      const ok = confirm('JSONã®å†…å®¹ã§ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ï¼ˆç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ');
      if (!ok) return;

      try {
        const text = await file.text();
        const parsed = JSON.parse(text);

        if (!isValidAllDataShape(parsed)) {
          alert('ã“ã®JSONã¯å½¢å¼ãŒé•ã†ã¿ãŸã„ã€‚æ—¥å ±ã‚¢ãƒ—ãƒªãŒå‡ºåŠ›ã—ãŸJSONã‚’é¸ã‚“ã§ã­ã€‚');
          return;
        }

        saveAll(parsed);
        editingIndex = null;
        renderForDate(getSelectedDateKey());

        fileInput.value = '';
        alert('å¾©å…ƒãŒå®Œäº†ã—ãŸã‚ˆ');
      } catch (e) {
        alert(`å¾©å…ƒã«å¤±æ•—ï¼š${e?.message || e}`);
      }
    };

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    // èµ·å‹•æ™‚åæ˜ 
    onDateChanged();
  </script>
</body>
</html>
