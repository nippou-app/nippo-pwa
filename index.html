<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—¥å ±ã‚¢ãƒ—ãƒª</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#1976d2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- â˜…è¿½åŠ ï¼šå›½åœŸåœ°ç†é™¢ï¼ˆGSIï¼‰å¸‚åŒºç”ºæ‘ã‚³ãƒ¼ãƒ‰å¤‰æ›ç”¨ -->
  <script src="https://maps.gsi.go.jp/js/muni.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 16px; background: #f5f5f5; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    .card { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    label { font-size: 16px; margin-top: 8px; display: block; font-weight: 600; }
    button, select, input, textarea { width: 100%; padding: 10px; margin-top: 6px; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; }
    .value { margin-top: 6px; font-size: 14px; color: #333; }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #ddd; padding: 6px; font-size: 14px; vertical-align: top; }
    th { background: #eee; }

    .delBtn { width: auto; padding: 6px 10px; font-size: 14px; margin-right: 6px; }

    .checkRow { display: flex; gap: 10px; align-items: center; margin-top: 8px; }
    .checkRow input[type="checkbox"]{ width: auto; transform: scale(1.2); margin: 0; }
    .checkRow span{ font-size: 14px; }

    .odoRow { display: flex; gap: 12px; }
    .odoCol { flex: 1; }

    .timeRowAll {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .timeRowAll button:not(.btnSmall) { flex: 1; min-width: 120px; }
    .btnSmall { width: auto; padding: 8px 10px; font-size: 13px; flex: 0 0 auto; }

    .sectionDivider { margin: 20px 0 16px; border: none; border-top: 2px solid #ccc; }

    #startBtn, #endBtn, #locBtn { background-color: #e6f4ea; border: 1px solid #b7dfc5; color: #1b5e20; }
    #startBtn:hover, #endBtn:hover, #locBtn:hover { background-color: #d8efdf; }

    #addBtn {
      background-color: #2e7d32;
      color: #fff;
      font-weight: 700;
      font-size: 17px;
      padding: 14px;
      border: none;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }
    #addBtn:hover { background-color: #256628; }
    #addBtn:active { background-color: #1b5e20; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); transform: translateY(1px); }

    .backupCard { padding: 12px; }
    .backupCard label { font-size: 13px; font-weight: 600; color: #555; }
    .backupCard button { font-size: 14px; padding: 8px 10px; }
    .backupCard input[type="file"] { font-size: 13px; padding: 6px; }

    .dangerMenu { margin-top: 10px; }
    .dangerMenu summary { cursor: pointer; font-size: 13px; color: #555; user-select: none; }

    .btnDangerSmall {
      width: auto;
      margin-top: 8px;
      padding: 8px 10px;
      font-size: 13px;
      background: #fdecea;
      border: 1px solid #f5c2c0;
      color: #b42318;
      border-radius: 8px;
    }
    .btnDangerSmall:hover { background: #fbd5d1; }
    .btnDangerSmall:active { transform: translateY(1px); }

    .dangerNote { margin-top: 6px; font-size: 12px; color: #777; }

    /* ===== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
    .modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 12px;
    }
    .modalOverlay.show { display: flex; }

    .modalPanel {
      width: 100%;
      max-width: 720px;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .modalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid #e5e5e5;
      background: #fafafa;
    }
    .modalTitle { font-weight: 700; font-size: 16px; }
    .modalClose {
      width: auto;
      padding: 6px 10px;
      font-size: 18px;
      border: none;
      background: transparent;
      cursor: pointer;
    }

    .modalBody { padding: 14px; }
    .modalBody label { font-size: 14px; font-weight: 600; margin-top: 10px; display: block; }
    .modalBody input, .modalBody select, .modalBody textarea {
      width: 100%;
      box-sizing: border-box;
      margin-top: 6px;
      font-size: 16px;
      padding: 10px;
    }

    .modalFooter {
      display: flex;
      gap: 10px;
      padding: 12px 14px;
      border-top: 1px solid #e5e5e5;
      background: #fafafa;
    }
    .modalFooter button { flex: 1; }

    .btnPrimary {
      background: #2e7d32;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 700;
    }
    .btnPrimary:active { transform: translateY(1px); }

    .valueInput{
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <h1>ğŸ“˜ æ—¥å ±ã‚¢ãƒ—ãƒª</h1>

  <div class="card">
    <label>æ—¥ä»˜</label>
    <input type="date" id="date" />

    <label>æ—¥ã€…ãƒã‚§ãƒƒã‚¯</label>
    <div class="checkRow">
      <input type="checkbox" id="chkCarDaily" />
      <span>ç¤¾ç”¨è»Šã®æ—¥æ¬¡ç‚¹æ¤œã‚’å®Ÿæ–½æ¸ˆ</span>
    </div>
    <div class="checkRow">
      <input type="checkbox" id="chkAlcohol" />
      <span>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½æ¸ˆ</span>
    </div>

    <label>èµ°è¡Œè·é›¢ï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰</label>
    <div class="odoRow">
      <div class="odoCol">
        <label>Aï¼šå‡ºå‹¤æ™‚ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆkmï¼‰</label>
        <input type="number" id="odoA" inputmode="decimal" placeholder="ä¾‹ï¼š12345">
      </div>
      <div class="odoCol">
        <label>Bï¼šé€€å‹¤æ™‚ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆkmï¼‰</label>
        <input type="number" id="odoB" inputmode="decimal" placeholder="ä¾‹ï¼š12410">
      </div>
    </div>

    <label>Cï¼šæœ¬æ—¥ã®èµ°è¡Œè·é›¢ï¼ˆkmï¼‰</label>
    <input type="text" id="odoC" readonly placeholder="Aã¨Bã‚’å…¥ã‚Œã‚‹ã¨è‡ªå‹•è¨ˆç®—ï¼ˆB-Aï¼‰">
    <hr class="sectionDivider">

    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰é¸æŠï¼‰</label>
    <select id="status">
      <option value="">æœªé¸æŠ</option>
      <option value="å‡ºå‹¤">å‡ºå‹¤</option>
      <option value="é€€å‹¤">é€€å‹¤</option>
      <option value="ç´å“">ç´å“</option>
      <option value="å¼•ãå–ã‚Š">å¼•ãå–ã‚Š</option>
      <option value="åŠ©æ‰‹">åŠ©æ‰‹</option>
      <option value="ä¼‘æ†©">ä¼‘æ†©</option>
    </select>

    <div class="timeRowAll">
      <button id="startBtn" type="button">é–‹å§‹æ™‚åˆ»ã‚’å–å¾—</button>
      <button id="startClearBtn" type="button" class="btnSmall">é–‹å§‹ã‚¯ãƒªã‚¢</button>

      <button id="endBtn" type="button">çµ‚äº†æ™‚åˆ»ã‚’å–å¾—</button>
      <button id="endClearBtn" type="button" class="btnSmall">çµ‚äº†ã‚¯ãƒªã‚¢</button>
    </div>

    <input type="text" id="startTime" class="valueInput" placeholder="é–‹å§‹ï¼ˆyyyy/mm/dd hh:mmï¼‰">
    <input type="text" id="endTime" class="valueInput" placeholder="çµ‚äº†ï¼ˆyyyy/mm/dd hh:mmï¼‰">

    <button id="locBtn" type="button">ç¾åœ¨åœ°ã‚’å–å¾—</button>
    <input type="text" id="location" class="valueInput" placeholder="å ´æ‰€ï¼ˆéƒ½é“åºœçœŒ å¸‚åŒºç”ºæ‘ï¼‰">

    <label>ãƒ¡ãƒ¢</label>
    <textarea id="memo" rows="2"></textarea>

    <button id="addBtn" type="button">ç™»éŒ²</button>

    <button id="exportCsvBtn" type="button">ã“ã®æœˆã®CSVã‚’å‡ºåŠ›</button>

    <hr class="sectionDivider">
  </div>

  <div class="card">
    <h2>ä»Šæ—¥ã®è¨˜éŒ²</h2>
    <table>
      <thead>
        <tr>
          <th>é–‹å§‹</th><th>çµ‚äº†</th><th>å ´æ‰€</th><th>çŠ¶æ…‹</th><th>ãƒ¡ãƒ¢</th><th>ç·¨é›†</th><th>å‰Šé™¤</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>

  <div class="card backupCard">
    <label>å…¨ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒ</label>

    <button id="exportJsonBtn" type="button">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’JSONã§å‡ºåŠ›ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</button>

    <label style="margin-top:12px;">JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</label>
    <input type="file" id="importJsonFile" accept="application/json,.json">
    <button id="importJsonBtn" type="button">JSONã‚’èª­ã¿è¾¼ã‚“ã§å¾©å…ƒï¼ˆä¸Šæ›¸ãï¼‰</button>

    <details class="dangerMenu">
      <summary>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</summary>
      <button id="clearAllBtn" type="button" class="btnDangerSmall">ç«¯æœ«å†…ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å‰Šé™¤</button>
      <div class="dangerNote">â€»æ—¥å ±ãƒ»èµ°è¡Œè·é›¢ãƒ»æ—¥ã€…ãƒã‚§ãƒƒã‚¯ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰</div>
    </details>
  </div>

  <div id="editModal" class="modalOverlay" aria-hidden="true">
    <div class="modalPanel" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
      <div class="modalHeader">
        <div id="editModalTitle" class="modalTitle">è¨˜éŒ²ã‚’ç·¨é›†</div>
        <button type="button" id="editCloseBtn" class="modalClose">Ã—</button>
      </div>

      <div class="modalBody">
        <label>é–‹å§‹ï¼ˆyyyy/mm/dd hh:mm / ç©ºOKï¼‰</label>
        <input type="text" id="editStart" placeholder="ä¾‹ï¼š2025/12/30 09:05">

        <label>çµ‚äº†ï¼ˆyyyy/mm/dd hh:mm / ç©ºOKï¼‰</label>
        <input type="text" id="editEnd" placeholder="ä¾‹ï¼š2025/12/30 18:10">

        <label>å ´æ‰€ï¼ˆç©ºã§ã‚‚OKï¼‰</label>
        <input type="text" id="editLoc" placeholder="ä¾‹ï¼šåƒè‘‰çœŒ èˆ¹æ©‹å¸‚">

        <label>çŠ¶æ…‹</label>
        <select id="editStatus"></select>

        <label>ãƒ¡ãƒ¢</label>
        <textarea id="editMemo" rows="5" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="modalFooter">
        <button type="button" id="editCancelBtn" class="delBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" id="editSaveBtn" class="btnPrimary">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    const STATUS_OPTIONS = [
      { value: '', label: 'æœªé¸æŠ' },
      { value: 'å‡ºå‹¤', label: 'å‡ºå‹¤' },
      { value: 'é€€å‹¤', label: 'é€€å‹¤' },
      { value: 'ç´å“', label: 'ç´å“' },
      { value: 'å¼•ãå–ã‚Š', label: 'å¼•ãå–ã‚Š' },
      { value: 'åŠ©æ‰‹', label: 'åŠ©æ‰‹' },
      { value: 'ä¼‘æ†©', label: 'ä¼‘æ†©' },
    ];

    function formatDateTime(date) {
      const pad = n => String(n).padStart(2, '0');
      return date.getFullYear() + '/' + pad(date.getMonth()+1) + '/' + pad(date.getDate()) + ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes());
    }
    function isValidDateTimeText(s) {
      return /^\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}$/.test(String(s || '').trim());
    }
    function clearTimes() {
      document.getElementById('startTime').value = '';
      document.getElementById('endTime').value = '';
    }

    // ===== ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚­ãƒ¼ =====
    const STORAGE_KEY = 'nippoRecordsV1';     // è¨˜éŒ²ï¼ˆè¡Œï¼‰
    const ODO_KEY     = 'nippoOdoV1';         // èµ°è¡Œè·é›¢ï¼ˆA/Bï¼‰
    const CHECKS_KEY  = 'nippoDailyChecksV1'; // æ—¥ã€…ãƒã‚§ãƒƒã‚¯

    function loadAll() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch { return {}; } }
    function saveAll(all) { localStorage.setItem(STORAGE_KEY, JSON.stringify(all)); }
    function getSelectedDateKey() { return document.getElementById('date').value; }

    function loadOdoAll() { try { return JSON.parse(localStorage.getItem(ODO_KEY) || '{}'); } catch { return {}; } }
    function saveOdoAll(all) { localStorage.setItem(ODO_KEY, JSON.stringify(all)); }

    function loadChecksAll(){ try { return JSON.parse(localStorage.getItem(CHECKS_KEY)||'{}'); } catch { return {}; } }
    function saveChecksAll(all){ localStorage.setItem(CHECKS_KEY, JSON.stringify(all)); }

    function calcDistance(a,b){
      if (a===''||b==='') return '';
      const na=Number(a), nb=Number(b);
      if(!Number.isFinite(na)||!Number.isFinite(nb)) return '';
      const d=nb-na;
      return Number.isFinite(d)?String(d):'';
    }
    function setOdoUI(a,b){
      document.getElementById('odoA').value=(a??'');
      document.getElementById('odoB').value=(b??'');
      document.getElementById('odoC').value=calcDistance(a??'', b??'');
    }
    function loadOdoForDate(dateKey){
      const all=loadOdoAll();
      const data=all[dateKey]||{a:'',b:''};
      setOdoUI(data.a??'', data.b??'');
    }
    function saveOdoForDate(dateKey){
      const a=document.getElementById('odoA').value.trim();
      const b=document.getElementById('odoB').value.trim();
      const all=loadOdoAll();
      all[dateKey]={a,b};
      saveOdoAll(all);
      document.getElementById('odoC').value=calcDistance(a,b);
    }

    function setChecksUI(state){
      document.getElementById('chkCarDaily').checked=!!state?.carDaily;
      document.getElementById('chkAlcohol').checked=!!state?.alcohol;
    }
    function loadChecksForDate(dateKey){
      const all=loadChecksAll();
      const state = all[dateKey] ?? { carDaily: true, alcohol: true };
      setChecksUI(state);
      // æœªä¿å­˜ãªã‚‰åˆæœŸå€¤ã‚’ä¿å­˜ã—ã¦ãŠãï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONç¶­æŒï¼‰
      if (!(dateKey in all)) { all[dateKey]=state; saveChecksAll(all); }
    }
    function saveChecksForDate(dateKey){
      const all=loadChecksAll();
      all[dateKey]={
        carDaily: document.getElementById('chkCarDaily').checked,
        alcohol: document.getElementById('chkAlcohol').checked,
      };
      saveChecksAll(all);
    }

    function normalizeRecord(r){
      const start = (typeof r.start==='string')?r.start : (typeof r.datetime==='string')?r.datetime : '';
      const end = (typeof r.end==='string')?r.end:'';
      return { start, end, location:String(r.location??''), status:String(r.status??''), memo:String(r.memo??'') };
    }

    function renderForDate(dateKey){
      const tbody=document.getElementById('list');
      tbody.innerHTML='';
      const all=loadAll();
      const rowsRaw=all[dateKey]||[];
      const rows=rowsRaw.map(normalizeRecord);
      if(rowsRaw.length>0){ all[dateKey]=rows; saveAll(all); }

      rows.forEach((r,idx)=>{
        const tr=document.createElement('tr');
        const tdStart=document.createElement('td');
        const tdEnd=document.createElement('td');
        const tdLoc=document.createElement('td');
        const tdStatus=document.createElement('td');
        const tdMemo=document.createElement('td');
        const tdEdit=document.createElement('td');
        const tdDel=document.createElement('td');

        tdStart.textContent=r.start;
        tdEnd.textContent=r.end;
        tdLoc.textContent=r.location;
        tdStatus.textContent=r.status;
        tdMemo.textContent=r.memo;

        const editBtn=document.createElement('button');
        editBtn.type='button';
        editBtn.textContent='ç·¨é›†';
        editBtn.className='delBtn';
        editBtn.addEventListener('click',()=>openEditModal(dateKey, idx, r));
        tdEdit.appendChild(editBtn);

        const delBtn=document.createElement('button');
        delBtn.type='button';
        delBtn.textContent='å‰Šé™¤';
        delBtn.className='delBtn';
        delBtn.addEventListener('click',()=>{
          const ok=confirm('ã“ã®è¡Œã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ');
          if(!ok) return;
          const all2=loadAll();
          const rows2=(all2[dateKey]||[]).map(normalizeRecord);
          rows2.splice(idx,1);
          all2[dateKey]=rows2;
          saveAll(all2);
          renderForDate(dateKey);
        });
        tdDel.appendChild(delBtn);

        tr.appendChild(tdStart); tr.appendChild(tdEnd); tr.appendChild(tdLoc); tr.appendChild(tdStatus); tr.appendChild(tdMemo); tr.appendChild(tdEdit); tr.appendChild(tdDel);
        tbody.appendChild(tr);
      });
    }

    function escapeCsvCell(value){
      const s=String(value??'');
      if (/[,"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }
    function downloadText(filename,text,mime='text/plain',withBom=false){
      const bom=withBom?'\ufeff':'';
      const blob=new Blob([bom+text],{type:mime+';charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // =========================================================
    // âœ… JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒï¼šè¨˜éŒ² + èµ°è¡Œè·é›¢ + æ—¥ã€…ãƒã‚§ãƒƒã‚¯ å¯¾å¿œ
    // - æ–°å½¢å¼ï¼š{ version:2, records:{...}, odo:{...}, checks:{...} }
    // - æ—§å½¢å¼ï¼š{ "YYYY-MM-DD":[{...}, ...], ... }ï¼ˆè¨˜éŒ²ã®ã¿ï¼‰
    // =========================================================

    function isValidDateKey(s){ return /^\d{4}-\d{2}-\d{2}$/.test(String(s||'')); }

    function isValidRecordsShape(records){
      if (typeof records !== 'object' || records === null || Array.isArray(records)) return false;

      for (const [dateKey, rows] of Object.entries(records)) {
        if (!isValidDateKey(dateKey)) return false;
        if (!Array.isArray(rows)) return false;

        for (const r of rows) {
          if (typeof r !== 'object' || r === null) return false;

          const hasNew = ('start' in r) || ('end' in r);
          const hasOld = ('datetime' in r);
          if (!hasNew && !hasOld) return false;

          if (hasOld && typeof r.datetime !== 'string') return false;
          if ('start' in r && typeof r.start !== 'string') return false;
          if ('end' in r && typeof r.end !== 'string') return false;

          if (typeof r.location !== 'string') return false;
          if (typeof r.status !== 'string') return false;
          if (typeof r.memo !== 'string') return false;
        }
      }
      return true;
    }

    function isValidOdoShape(odo){
      if (typeof odo !== 'object' || odo === null || Array.isArray(odo)) return false;
      for (const [dateKey, v] of Object.entries(odo)) {
        if (!isValidDateKey(dateKey)) return false;
        if (typeof v !== 'object' || v === null || Array.isArray(v)) return false;
        // a/b ã¯æ–‡å­—åˆ—æƒ³å®šï¼ˆç©ºOKï¼‰
        if (!('a' in v) || !('b' in v)) return false;
        if (typeof v.a !== 'string') return false;
        if (typeof v.b !== 'string') return false;
      }
      return true;
    }

    function isValidChecksShape(checks){
      if (typeof checks !== 'object' || checks === null || Array.isArray(checks)) return false;
      for (const [dateKey, v] of Object.entries(checks)) {
        if (!isValidDateKey(dateKey)) return false;
        if (typeof v !== 'object' || v === null || Array.isArray(v)) return false;
        if (!('carDaily' in v) || !('alcohol' in v)) return false;
        if (typeof v.carDaily !== 'boolean') return false;
        if (typeof v.alcohol !== 'boolean') return false;
      }
      return true;
    }

    function detectBackupFormat(parsed){
      // æ–°å½¢å¼
      if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
        if (parsed.version === 2 && ('records' in parsed)) return 'v2';
        // å°†æ¥ã®æ‹¡å¼µã‚‚è¦‹è¶Šã—ã¦ version ãŒæ•°å€¤ã§ records/odo/checksãŒã‚ã‚‹ãªã‚‰ v2æ‰±ã„
        if (('records' in parsed) && ('odo' in parsed) && ('checks' in parsed)) return 'v2';
      }
      // æ—§å½¢å¼ï¼ˆrecords-onlyï¼‰
      if (isValidRecordsShape(parsed)) return 'legacy_records_only';
      return 'unknown';
    }

    function makeBackupV2(){
      const records = loadAll();
      const odo     = loadOdoAll();
      const checks  = loadChecksAll();

      return {
        version: 2,
        exportedAt: new Date().toISOString(),
        records,
        odo,
        checks,
      };
    }

    function getTodayLocalISO(){
      const d=new Date();
      d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
      return d.toISOString().slice(0,10);
    }

    const today=getTodayLocalISO();
    document.getElementById('date').value=today;

    function onDateChanged(){
      const dateKey=getSelectedDateKey();
      renderForDate(dateKey);
      loadOdoForDate(dateKey);
      loadChecksForDate(dateKey);
      clearTimes();
    }
    document.getElementById('date').addEventListener('change', onDateChanged);

    document.getElementById('odoA').addEventListener('input',()=>saveOdoForDate(getSelectedDateKey()));
    document.getElementById('odoB').addEventListener('input',()=>saveOdoForDate(getSelectedDateKey()));

    document.getElementById('chkCarDaily').addEventListener('change',()=>saveChecksForDate(getSelectedDateKey()));
    document.getElementById('chkAlcohol').addEventListener('change',()=>saveChecksForDate(getSelectedDateKey()));

    document.getElementById('startBtn').onclick=()=>{ document.getElementById('startTime').value=formatDateTime(new Date()); };
    document.getElementById('endBtn').onclick=()=>{ document.getElementById('endTime').value=formatDateTime(new Date()); };
    document.getElementById('startClearBtn').onclick=()=>{ document.getElementById('startTime').value=''; };
    document.getElementById('endClearBtn').onclick=()=>{ document.getElementById('endTime').value=''; };

    // ç¾åœ¨åœ°å–å¾—
    document.getElementById('locBtn').onclick=()=>{
      const locEl=document.getElementById('location');
      locEl.value='ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­â€¦';

      if(!navigator.geolocation){
        locEl.value='ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“';
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat=pos.coords.latitude;
        const lon=pos.coords.longitude;

        // â‘  GSI
        try{
          const gsiUrl=`https://mreversegeocoder.gsi.go.jp/reverse-geocoder/LonLatToAddress?lat=${lat}&lon=${lon}`;
          const gsiRes=await fetch(gsiUrl);
          if(gsiRes.ok){
            const gsi=await gsiRes.json();
            const muniCd=gsi?.results?.muniCd;
            if(muniCd && window.GSI && GSI.MUNI_ARRAY){
              const key=String(muniCd).replace(/^0+/,'');
              const row=GSI.MUNI_ARRAY[key];
              if(row){
                const parts=row.split(',');
                const prefName=parts[1]||'';
                const cityName=parts[3]||'';
                const place=[prefName, cityName].filter(Boolean).join(' ');
                locEl.value = place || 'ä½æ‰€ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆGSI: ãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼‰';
                return;
              }
            }
          }
        }catch(e){}

        // â‘¡ Nominatim
        try{
          locEl.value = `ç·¯åº¦çµŒåº¦å–å¾—OKï¼ˆ${lat.toFixed(6)}, ${lon.toFixed(6)}ï¼‰â†’ ä½æ‰€å¤‰æ›ä¸­â€¦`;

          const nominatimUrl=
            `https://nominatim.openstreetmap.org/reverse?`+
            `format=jsonv2&lat=${lat}&lon=${lon}&zoom=14&addressdetails=1&accept-language=ja`;

          const res=await fetch(nominatimUrl, { headers:{'Accept-Language':'ja'} });
          if(!res.ok){
            locEl.value=`ä½æ‰€å¤‰æ›ã«å¤±æ•—ï¼ˆNominatim HTTP ${res.status}ï¼‰`;
            return;
          }

          const data=await res.json();
          const addr=data.address||{};
          const prefecture = addr.province || addr.state || addr.region || addr.state_district || '';
          const city = addr.city || addr.municipality || addr.town || addr.village || addr.city_district || addr.county || addr.suburb || '';

          if(prefecture || city){
            locEl.value=[prefecture, city].filter(Boolean).join(' ');
            return;
          }

          const dn=(data.display_name||'').split(',').slice(0,3).join(',').trim();
          locEl.value = dn ? dn : 'ä½æ‰€ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆNominatim: ãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼‰';
        }catch(e){
          locEl.value = `ä½æ‰€å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ${e?.message || e}ï¼‰`;
        }
      }, (err)=>{
        const codeMap={
          1:'è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆä½ç½®æƒ…å ±ã®è¨±å¯ãŒOFFï¼‰',
          2:'ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ï¼ˆé›»æ³¢/GPS/ç«¯æœ«è¨­å®šï¼‰',
          3:'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ',
        };
        document.getElementById('location').value =
          `ä½ç½®æƒ…å ±ã®å–å¾—ãŒã§ãã¾ã›ã‚“ã§ã—ãŸï¼š${codeMap[err.code] || 'ä¸æ˜'} / ${err.message}`;
      }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    };

    // ç™»éŒ²
    document.getElementById('addBtn').onclick=()=>{
      const dateKey=getSelectedDateKey();
      const start=document.getElementById('startTime').value.trim();
      const end=document.getElementById('endTime').value.trim();

      if(start && !isValidDateTimeText(start)){ alert('é–‹å§‹ã®å½¢å¼ãŒé•ã†ã‚ˆã€‚ä¾‹ï¼š2025/12/30 09:05'); return; }
      if(end && !isValidDateTimeText(end)){ alert('çµ‚äº†ã®å½¢å¼ãŒé•ã†ã‚ˆã€‚ä¾‹ï¼š2025/12/30 18:10'); return; }

      const record={
        start, end,
        location: document.getElementById('location').value.trim(),
        status: document.getElementById('status').value,
        memo: document.getElementById('memo').value || ''
      };

      const all=loadAll();
      all[dateKey]=(all[dateKey]||[]).map(normalizeRecord);
      all[dateKey].push(record);
      saveAll(all);

      renderForDate(dateKey);

      document.getElementById('memo').value='';
      clearTimes();
    };

    // CSVå‡ºåŠ›
    document.getElementById('exportCsvBtn').onclick = () => {
      const selected = getSelectedDateKey();
      if (!selected) {
        alert('æ—¥ä»˜ã‚’é¸ã‚“ã§ã­');
      return;
      }

      // å¯¾è±¡å¹´æœˆï¼ˆYYYY-MMï¼‰
      const ym = selected.slice(0, 7);

      const recordsAll = loadAll();
      const odoAll = loadOdoAll();
      const checksAll = loadChecksAll();

      // å¯¾è±¡æœˆã«å­˜åœ¨ã™ã‚‹æ—¥ä»˜ã‚­ãƒ¼ã‚’åé›†ï¼ˆrecords/odo/checksã®ã„ãšã‚Œã‹ã«ã‚ã‚‹æ—¥ã ã‘ï¼‰
      const dateSet = new Set();

      for (const k of Object.keys(recordsAll || {})) if (k.startsWith(ym + '-')) dateSet.add(k);
      for (const k of Object.keys(odoAll || {}))     if (k.startsWith(ym + '-')) dateSet.add(k);
      for (const k of Object.keys(checksAll || {}))  if (k.startsWith(ym + '-')) dateSet.add(k);

      // ã‚‚ã—å…¨éƒ¨ç©ºãªã‚‰ã€åˆ†ã‹ã‚Šã‚„ã™ãçµ‚äº†
      if (dateSet.size === 0) {
        alert('ã“ã®æœˆã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
      }

      const dates = Array.from(dateSet).sort(); // æ˜‡é †

      // ãã®æœˆã®ã€Œæœ€å¤§è¨˜éŒ²ä»¶æ•°ã€ã‚’æ•°ãˆã‚‹ï¼ˆãƒ˜ãƒƒãƒ€åˆ—æ•°æ±ºå®šï¼‰
      let maxRecs = 0;
      for (const dk of dates) {
        const rows = (recordsAll[dk] || []).map(normalizeRecord);
      if (rows.length > maxRecs) maxRecs = rows.length;
      }

      // ãƒ˜ãƒƒãƒ€ä½œæˆ
      const header = [
        'å¹´æœˆæ—¥',
        'è»Šã®æ—¥æ¬¡ç‚¹æ¤œ',
        'ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯',
        'å‡ºå‹¤æ™‚ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼(km)',
        'é€€å‹¤æ™‚ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼(km)',
        'å½“æ—¥ã®èµ°è¡Œè·é›¢',
      ];

      for (let i = 1; i <= maxRecs; i++) {
        header.push(
        `è¨˜éŒ²${i}_é–‹å§‹æ™‚åˆ»`,
        `è¨˜éŒ²${i}_çµ‚äº†æ™‚åˆ»`,
        `è¨˜éŒ²${i}_å ´æ‰€`,
        `è¨˜éŒ²${i}_çŠ¶æ…‹`,
        `è¨˜éŒ²${i}_ãƒ¡ãƒ¢`
        );
      }

      const lines = [];
      lines.push(header.map(escapeCsvCell).join(','));

      // è¡Œãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆ1æ—¥=1è¡Œï¼‰
      for (const dk of dates) {
        const checks = checksAll[dk] || { carDaily: false, alcohol: false };
        const carDailyStr = checks.carDaily ? 'æ¸ˆ' : '';
        const alcoholStr = checks.alcohol ? 'æ¸ˆ' : '';

        const odo = odoAll[dk] || { a: '', b: '' };
        const a = String(odo.a ?? '');
        const b = String(odo.b ?? '');
        const c = calcDistance(a, b);

        const rows = (recordsAll[dk] || []).map(normalizeRecord);

        const rowCols = [
          dk,
          carDailyStr,
          alcoholStr,
          a,
          b,
          c,
        ];

        // è¨˜éŒ²ï¼ˆæœ€å¤§ä»¶æ•°ã¾ã§æ¨ªå±•é–‹ã€‚è¶³ã‚Šãªã„åˆ†ã¯ç©ºæ¬„ã§åŸ‹ã‚ã‚‹ï¼‰
        for (let i = 0; i < maxRecs; i++) {
          const r = rows[i];
          if (r) {
            rowCols.push(
            r.start ?? '',
            r.end ?? '',
            r.location ?? '',
            r.status ?? '',
            r.memo ?? ''
          );
          } else {
          rowCols.push('', '', '', '', '');
          }
        }

        lines.push(rowCols.map(escapeCsvCell).join(','));
      }

        const csvText = lines.join('\n');
        const filename = `nippo_${ym.replace('-', '')}.csv`; // nippo_202601.csv ã¿ãŸã„ã«ãªã‚‹
        downloadText(filename, csvText, 'text/csv', true);
    };




    // âœ… JSONå‡ºåŠ›ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼šè¨˜éŒ² + èµ°è¡Œè·é›¢ + æ—¥ã€…ãƒã‚§ãƒƒã‚¯ï¼‰
    document.getElementById('exportJsonBtn').onclick=()=>{
      const records = loadAll();
      const odo     = loadOdoAll();
      const checks  = loadChecksAll();

      const hasAny =
        (records && Object.keys(records).length > 0) ||
        (odo && Object.keys(odo).length > 0) ||
        (checks && Object.keys(checks).length > 0);

      if(!hasAny){
        alert('ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const backup = makeBackupV2();
      const stamp=new Date().toISOString().slice(0,19).replace(/[-:T]/g,'');
      downloadText(`nippo_backup_${stamp}.json`, JSON.stringify(backup,null,2), 'application/json', false);
    };

    // âœ… JSONå¾©å…ƒï¼ˆæ–°å½¢å¼v2 / æ—§å½¢å¼ï¼ˆè¨˜éŒ²ã®ã¿ï¼‰ ä¸¡å¯¾å¿œï¼‰
    document.getElementById('importJsonBtn').onclick=async ()=>{
      const fileInput=document.getElementById('importJsonFile');
      const file=fileInput.files && fileInput.files[0];
      if(!file){ alert('å¾©å…ƒã™ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­'); return; }

      const ok=confirm('JSONã®å†…å®¹ã§ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ï¼ˆç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ');
      if(!ok) return;

      try{
        const text=await file.text();
        const parsed=JSON.parse(text);

        const fmt = detectBackupFormat(parsed);

        if (fmt === 'v2') {
          const records = parsed.records ?? {};
          const odo     = parsed.odo ?? {};
          const checks  = parsed.checks ?? {};

          if (!isValidRecordsShape(records)) {
            alert('å¾©å…ƒã«å¤±æ•—ï¼šrecordsï¼ˆè¨˜éŒ²ï¼‰ã®å½¢å¼ãŒé•ã†ã¿ãŸã„ã€‚');
            return;
          }
          if (!isValidOdoShape(odo)) {
            alert('å¾©å…ƒã«å¤±æ•—ï¼šodoï¼ˆèµ°è¡Œè·é›¢ï¼‰ã®å½¢å¼ãŒé•ã†ã¿ãŸã„ã€‚');
            return;
          }
          if (!isValidChecksShape(checks)) {
            alert('å¾©å…ƒã«å¤±æ•—ï¼šchecksï¼ˆæ—¥ã€…ãƒã‚§ãƒƒã‚¯ï¼‰ã®å½¢å¼ãŒé•ã†ã¿ãŸã„ã€‚');
            return;
          }

          // ä¸Šæ›¸ãå¾©å…ƒ
          saveAll(records);
          saveOdoAll(odo);
          saveChecksAll(checks);

        } else if (fmt === 'legacy_records_only') {
          // æ—§å½¢å¼ã¯ã€Œè¨˜éŒ²ã®ã¿ã€ä¸Šæ›¸ãå¾©å…ƒï¼ˆodo/checksã¯æ¶ˆã•ãªã„ï¼‰
          saveAll(parsed);

        } else {
          alert('ã“ã®JSONã¯å½¢å¼ãŒé•ã†ã¿ãŸã„ã€‚æ—¥å ±ã‚¢ãƒ—ãƒªãŒå‡ºåŠ›ã—ãŸJSONã‚’é¸ã‚“ã§ã­ã€‚');
          return;
        }

        // ç”»é¢åæ˜ 
        const dk = getSelectedDateKey();
        renderForDate(dk);
        loadOdoForDate(dk);
        loadChecksForDate(dk);

        fileInput.value='';
        alert(fmt === 'legacy_records_only'
          ? 'å¾©å…ƒãŒå®Œäº†ã—ãŸã‚ˆï¼ˆæ—§å½¢å¼ï¼šè¨˜éŒ²ã®ã¿å¾©å…ƒï¼‰'
          : 'å¾©å…ƒãŒå®Œäº†ã—ãŸã‚ˆï¼ˆè¨˜éŒ²ãƒ»èµ°è¡Œè·é›¢ãƒ»æ—¥ã€…ãƒã‚§ãƒƒã‚¯ï¼‰'
        );

      }catch(e){
        alert(`å¾©å…ƒã«å¤±æ•—ï¼š${e?.message || e}`);
      }
    };

    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }

    // ===== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚ãªãŸã®å®Ÿè£…ã‚’ãã®ã¾ã¾ç¶­æŒï¼‰ =====
    let editTargetDateKey=null;
    let editTargetIndex=null;

    function openEditModal(dateKey, idx, record){
      editTargetDateKey=dateKey;
      editTargetIndex=idx;

      document.getElementById('editStart').value=record.start || '';
      document.getElementById('editEnd').value=record.end || '';
      document.getElementById('editLoc').value=record.location || '';
      document.getElementById('editMemo').value=record.memo || '';

      const sel=document.getElementById('editStatus');
      sel.innerHTML=STATUS_OPTIONS.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
      sel.value=record.status || '';

      const modal=document.getElementById('editModal');
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=>document.getElementById('editStart').focus(),50);
    }

    function closeEditModal(){
      const modal=document.getElementById('editModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
      editTargetDateKey=null;
      editTargetIndex=null;
    }

    (function bindEditModalEvents(){
      const modal=document.getElementById('editModal');
      document.getElementById('editCloseBtn').addEventListener('click', closeEditModal);
      document.getElementById('editCancelBtn').addEventListener('click', closeEditModal);
      modal.addEventListener('click',(e)=>{ if(e.target===modal) closeEditModal(); });

      document.getElementById('editSaveBtn').addEventListener('click',()=>{
        if(editTargetDateKey==null || editTargetIndex==null) return;

        const newStart=document.getElementById('editStart').value.trim();
        const newEnd=document.getElementById('editEnd').value.trim();
        const newLoc=document.getElementById('editLoc').value.trim();
        const newStatus=document.getElementById('editStatus').value;
        const newMemo=document.getElementById('editMemo').value;

        if(newStart && !isValidDateTimeText(newStart)){ alert('é–‹å§‹ã®å½¢å¼ãŒé•ã†ã‚ˆã€‚ä¾‹ï¼š2025/12/30 09:05'); return; }
        if(newEnd && !isValidDateTimeText(newEnd)){ alert('çµ‚äº†ã®å½¢å¼ãŒé•ã†ã‚ˆã€‚ä¾‹ï¼š2025/12/30 18:10'); return; }

        const all2=loadAll();
        const rows2=(all2[editTargetDateKey]||[]).map(normalizeRecord);
        if(!rows2[editTargetIndex]) return;

        rows2[editTargetIndex].start=newStart;
        rows2[editTargetIndex].end=newEnd;
        rows2[editTargetIndex].location=newLoc;
        rows2[editTargetIndex].status=newStatus;
        rows2[editTargetIndex].memo=String(newMemo ?? '');

        all2[editTargetDateKey]=rows2;
        saveAll(all2);

        closeEditModal();
        renderForDate(editTargetDateKey);
      });
    })();

    // ===== å…¨ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ã‚¯ãƒªã‚¢ =====
    (function bindClearAllButton(){
      const btn=document.getElementById('clearAllBtn');
      if(!btn){ console.log('[clearAll] ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„'); return; }
      if(btn.dataset.bound==='1') return;
      btn.dataset.bound='1';

      btn.addEventListener('click',()=>{
        const ok=confirm(
          'ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n' +
          'ï¼ˆæ—¥å ±ãƒ»èµ°è¡Œè·é›¢ãƒ»æ—¥ã€…ãƒã‚§ãƒƒã‚¯ï¼‰\n' +
          'ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'
        );
        if(!ok) return;

        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(ODO_KEY);
        localStorage.removeItem(CHECKS_KEY);

        const locEl=document.getElementById('location');
        if(locEl) locEl.value='';

        const memoEl=document.getElementById('memo');
        if(memoEl) memoEl.value='';

        clearTimes();

        const dk = getSelectedDateKey();
        renderForDate(dk);
        setOdoUI('', '');
        setChecksUI({ carDaily: false, alcohol: false });

        alert('ç«¯æœ«å†…ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
      });
    })();

    onDateChanged();
  </script>
</body>
</html>
